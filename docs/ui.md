# Gradio UI 설계 문서

## 개요

Multi-Agent Chatbot의 웹 인터페이스입니다.
Gradio 6.0 기반으로 구현되며, 채팅, 설정, 파일 관리, HTML 미리보기 기능을 제공합니다.

## 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  🤖 Multi-Agent Chatbot                                         │
├─────────────────────────────────────────────────────────────────┤
│  ▶ LLM Settings                                                 │
│     ├─ Ollama URL, 모델 새로고침                                │
│     ├─ Model, Temperature, Max Tokens                           │
│     └─ ▶ Advanced Settings                                      │
├─────────────────────────────────────────────────────────────────┤
│  ▶ Workspace Files                                              │
│     ├─ 파일 업로드                                               │
│     ├─ 파일 목록 (출처, 크기)                                    │
│     └─ 삭제 기능                                                 │
├─────────────────────────────────────────────────────────────────┤
│  ▶ History                                                      │
│     └─ 이전 대화 목록                                            │
├─────────────────────────────────────────────────────────────────┤
│  ▶ HTML 미리보기                                                │
│     ├─ HTML ID 입력                                             │
│     ├─ 미리보기 (iframe)                                        │
│     └─ 소스 복사                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                         채팅 영역                                │
│                                                                 │
│  (User, Assistant 메시지)                                       │
│  (중간 Step 결과 - 접이식)                                       │
│  (HTML 결과 - 요약 + ID)                                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  [메시지 입력...]                              [전송] [중지]     │
│  [🗑️ 대화 초기화]                                    Ready      │
└─────────────────────────────────────────────────────────────────┘
```

## 기능 상세

### 1. LLM Settings

접이식 패널로 기본 닫힘. 설정 변경 시 즉시 반영 + 자동 저장.

#### 기본 설정 (최상단)
| 항목 | 타입 | 설명 |
|------|------|------|
| Ollama URL | Text | Ollama 서버 주소 (기본: http://localhost:11434) |
| 모델 새로고침 | Button | Ollama 서버에서 가용 모델 목록 조회 |

#### 모델 설정
| 항목 | 타입 | 범위 | 기본값 |
|------|------|------|--------|
| Model | Dropdown | Ollama 서버에서 조회 | (첫 번째 모델) |
| Temperature | Slider | 0.0 ~ 2.0 | 0.7 |
| Max Tokens | Slider | 256 ~ 4096 | 2048 |

#### 고급 설정 (한 번 더 접힘)
| 항목 | 타입 | 범위 | 기본값 |
|------|------|------|--------|
| Top-p | Slider | 0.0 ~ 1.0 | 0.9 |
| Repeat Penalty | Slider | 1.0 ~ 2.0 | 1.1 |
| Context Window | Slider | 2048 ~ 8192 | 4096 |
| Max Steps | Slider | 1 ~ 20 | 10 |

### 2. Workspace Files

파일 업로드 및 관리 기능.

#### 구조
```
workspace/
├── config/
│   └── llm_config.json    ← 설정 자동 저장
├── uploads/               ← 업로드 원본 보존
└── files/                 ← FileTool 작업 공간
```

#### 기능
- 📤 파일 업로드 (다중 선택 가능)
- 📄 파일 목록 표시 (이름, 크기, 출처)
- 🗑️ 선택 삭제
- 🗑️ 전체 삭제
- 🔄 새로고침

#### 출처 표시
- 📤 업로드: 사용자가 업로드한 파일
- 🤖 생성: LLM/Tool이 생성한 파일

### 3. History

이전 대화 세션 목록 표시.

- 최근 10개 세션 표시
- 상태 아이콘: ✅ 완료, ⚠️ 오류
- 시간 표시

### 4. HTML 미리보기 (NEW)

web_tool.fetch로 가져온 HTML을 미리보고 복사할 수 있습니다.

#### 기능
| 요소 | 기능 |
|------|------|
| HTML ID 입력 | 채팅에서 표시된 HTML ID 입력 |
| 🔍 미리보기 | iframe으로 안전하게 렌더링 |
| 📋 소스복사 | HTML 소스 전체 표시 |

#### 보안
- 스크립트 태그 제거
- 이벤트 핸들러 제거
- javascript: URL 제거
- sandbox 속성으로 격리

#### 흐름
```
1. web_tool.fetch 실행 → HTML 감지됨

2. 채팅창에 표시:
   📄 **Google**
   Google 서비스에 오신 것을 환영합니다...
   📊 크기: 45.2KB ⚠️ 스크립트 포함
   🔑 HTML ID: `a1b2c3d4e5f6`

3. [🌐 HTML 미리보기] Accordion 열기

4. HTML ID 입력 → [미리보기] 클릭 → iframe 렌더링

5. [소스복사] → HTML 소스 표시 (복사 가능)
```

### 5. 채팅 영역

#### 메시지 표시 (Gradio 6.0)
- User 메시지: `{"role": "user", "content": "..."}`
- Assistant 메시지: `{"role": "assistant", "content": "..."}`
- Markdown 렌더링 지원

#### 중간 Step 결과 (접이식)
```html
<details>
<summary>🔧 Step 1: file_tool.read</summary>

```
[ERROR] DMA timeout...
[WARN] Retry failed...
```

</details>
```

#### HTML 결과 표시
web_tool.fetch로 HTML을 가져오면 특별 포맷으로 표시:

```
📄 **페이지 제목**

텍스트 미리보기 (300자)...

📊 크기: 45.2KB ⚠️ 스크립트 포함

🔑 HTML ID: `a1b2c3d4e5f6` (미리보기/복사에 사용)
```

#### Streaming
- 실시간으로 각 Step 진행 상황 표시
- 상태바에 현재 상태 표시

### 6. 입력 영역

| 요소 | 기능 |
|------|------|
| 메시지 입력 | 텍스트 입력, Enter로 전송 |
| 전송 버튼 | 메시지 전송 |
| 중지 버튼 | 생성 중지 |
| 대화 초기화 | 현재 대화 삭제 |

## 설정 자동 저장/로드

```
앱 시작
└─ config/llm_config.json 로드
   ├─ 있으면: 저장된 설정 적용
   └─ 없으면: 기본값 사용

Ollama 서버 연결
└─ /api/tags에서 가용 모델 목록 조회
   ├─ 성공: 모델 드롭다운 업데이트
   └─ 실패: 기본 모델 목록 사용

설정 변경 (슬라이더, 드롭다운)
└─ 1. Orchestrator에 즉시 반영
   2. config/llm_config.json 자동 저장

다음 앱 실행
└─ 저장된 설정 자동 로드
```

## 파일 위치

```
multi_agent_chatbot/
├── app.py                   ← Gradio UI 메인
├── core/
│   ├── workspace_manager.py ← 파일/설정 관리
│   ├── html_utils.py        ← HTML 파싱/미리보기
│   └── ...
└── workspace/               ← 런타임 데이터
    ├── config/
    │   └── llm_config.json
    ├── uploads/
    └── files/
```

## 실행 방법

```bash
cd multi_agent_chatbot
python app.py
```

브라우저에서 `http://localhost:7860` 접속

## 의존성

```
gradio>=6.0
requests
beautifulsoup4  # HTML 파싱
```

## 주요 함수

### chat_stream

```python
def chat_stream(message: str, history: List[Dict]) -> Generator:
    """채팅 메시지 처리 (Streaming)"""
    # Gradio 6.0: List[Dict] 형식 사용
    # {"role": "user/assistant", "content": "..."}
```

### format_tool_result

```python
def format_tool_result(content: str, tool_name: str, action: str) -> str:
    """Tool 결과를 포맷팅 (HTML 감지 포함)"""
    # web_tool.fetch + HTML → 특별 포맷
    # 일반 결과 → 코드 블록
```

### preview_html

```python
def preview_html(html_hash: str) -> Tuple[str, str]:
    """HTML 미리보기 생성 (iframe)"""
    # 저장된 HTML 조회
    # 보안 처리 (스크립트 제거)
    # iframe 생성
```

### get_html_source

```python
def get_html_source(html_hash: str) -> Tuple[str, str]:
    """HTML 소스 가져오기"""
    # 저장된 HTML 원본 반환
```

## 스크린샷

### 기본 화면
```
┌─────────────────────────────────────────────────────────────────┐
│  🤖 Multi-Agent Chatbot                                         │
├─────────────────────────────────────────────────────────────────┤
│  ▶ LLM Settings                                                 │
│  ▶ Workspace Files                                              │
│  ▶ History                                                      │
│  ▶ HTML 미리보기                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    대화를 시작해보세요!                          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  [메시지를 입력하세요...]                        [전송] [중지]  │
│  [🗑️ 대화 초기화]                                    Ready     │
└─────────────────────────────────────────────────────────────────┘
```

### HTML Fetch 결과
```
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User: https://google.com 페이지 가져와줘                       │
│                                                                 │
│  <details>                                                      │
│  <summary>🔧 Step 1: web_tool.fetch</summary>                   │
│                                                                 │
│  📄 **Google**                                                  │
│                                                                 │
│  Google 서비스에 오신 것을 환영합니다. 검색, 메일, 지도...      │
│                                                                 │
│  📊 크기: 45.2KB ⚠️ 스크립트 포함                              │
│                                                                 │
│  🔑 HTML ID: `a1b2c3d4e5f6`                                    │
│                                                                 │
│  </details>                                                     │
│                                                                 │
│  Assistant: Google 홈페이지를 가져왔습니다...                  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
```

### HTML 미리보기 패널
```
│  ▼ HTML 미리보기                                                │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ HTML ID: [a1b2c3d4e5f6        ] [🔍 미리보기] [📋 소스복사] │ │
│  ├────────────────────────────────────────────────────────────┤ │
│  │ ✅ HTML 미리보기 로드됨 (a1b2c3d4e5f6)                     │ │
│  ├────────────────────────────────────────────────────────────┤ │
│  │ ┌────────────────────────────────────────────────────────┐ │ │
│  │ │                   (iframe)                             │ │ │
│  │ │            렌더링된 HTML 페이지                         │ │ │
│  │ │                                                        │ │ │
│  │ └────────────────────────────────────────────────────────┘ │ │
│  │                                                            │ │
│  │ ▶ HTML 소스                                               │ │
│  └────────────────────────────────────────────────────────────┘ │
```